<html>
<head>
    <style>
        #emu_container {
            width: 350px;
            text-align: center;
            margin-left: auto;
            margin-right: auto;
        }

        #emu_container button {
            outline: none !important;
            height: 29px;
        }

        #emu_container .emscripten {
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }

        #emu_canvas_container, #emu_keypad_buttons {
            margin-top: 5px;
        }

        #emu_keypad_buttons {
            display: block;
            background-image: url(emu_keypad_84pce.png);
            background-repeat: no-repeat;
            background-position: center -15px;
            background-size: 100%;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: optimize-contrast;
        }

        #emu_canvas {
            border: 1px grey solid;
        }

        #emu_container input[type="file"] {
            display: inline-block !important;
            width: 210px;
        }

        #emu_keypad_buttons button:active {
            opacity: .5;
            font-size: 0;
            box-shadow: 0 0 8px 4px rgba(255, 0, 0, .75) inset;
        }

        #emu_keypad_buttons button {
            width: 46px;
            height: 27px;
            font-size: 14px;
            padding-top: 4px;
            margin: 7px 1px 12px;
            opacity: 0;
            position: relative;
        }

        #emu_keypad_buttons button.topRowButton {
            height: 22px;
            padding-top: 0;
            margin-top: 14px;
            margin-bottom: 20px;
        }

        #emu_keypad_buttons button.numeric1 {
            top: -6px;
            height: 31px;
            margin-bottom: 1px;
        }

        #emu_keypad_buttons button.numeric2 {
            top: -2px;
            height: 31px;
            margin-bottom: 1px;
        }

        #emu_keypad_buttons button.numeric3 {
            top: 2px;
            height: 32px;
            margin-bottom: 1px;
        }

        #emu_keypad_buttons button.numeric4 {
            top: 10px;
            height: 31px;
        }

        #cemu_notice {
            border-top: 2px grey solid;
            font-size: .9em;
            position: absolute;
            bottom: 6px;
            width: 100%;
            background-color: #f0f0f0;
            height: 24px;
            padding: 1px 0 0 5px;
        }

        .inputfile {
            width: .1px;
            height: .1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        .inputfile + label {
            font-size: 1.1rem;
            cursor: pointer;
            margin: 0;
            padding: .55rem 1.2rem;
            max-width: 110px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            border-radius: 4px;
            height: 29px;
        }

        #screenshot_btn_container {
            background-color: rgba(100, 100, 100, .5);
            width: 320px;
            margin: -42px auto auto;
            position: relative;
            padding: 6px;
            display: none;
        }
    </style>
</head>
<body>
<div id="emu_container" class="unselectable">
    <div id="emu_canvas_container">
        <canvas id="emu_canvas" class="emscripten" style="display:none;" oncontextmenu="event.preventDefault()"
                width="320" height="240"></canvas>
        <div id="screenshot_btn_container">
            <a target="_blank" download="" class="btn btn-default btn-sm" onclick="emu_screenshot(this)">
                <i class="glyphicon glyphicon-camera"></i> Screenshot
            </a>
            <button id="record_btn_start" class="btn btn-default btn-sm"><i class="glyphicon glyphicon-record"></i>
                Record webm
            </button>
            <button id="record_btn_stop" class="btn btn-default btn-sm" style="display: none"><i
                    class="glyphicon glyphicon-stop"></i> Stop recording
            </button>
        </div>
    </div>

    <div id="emu_keypad_buttons" style="display:none;">
        <script>
            const keypad = [
                ["y=", [4, 1]], ["wind", [3, 1]], ["zoom", [2, 1]], ["trace", [1, 1]], ["graph", [0, 1]],
                ["2nd", [5, 1]], ["mode", [6, 1]], ["del", [7, 1]], ["◀", [1, 7]], ["<big>▲</big>", [3, 7]],
                ["alpha", [7, 2]], ["XTθ<i>n</i>", [7, 3]], ["stat", [7, 4]], ["<big>▼</big>", [0, 7]], ["▶", [2, 7]],
                ["math", [6, 2]], ["apps", [6, 3]], ["prgm", [6, 4]], ["vars", [6, 5]], ["clear", [6, 6]],
                ["x<sup>-1</sup>", [5, 2]], ["sin", [5, 3]], ["cos", [5, 4]], ["tan", [5, 5]], ["ᐱ", [5, 6]],
                ["x<sup>2</sup>", [4, 2]], [",", [4, 3]], ["(", [4, 4]], [")", [4, 5]], ["/", [4, 6]],
                ["log", [3, 2]], ["<b>7</b>", [3, 3]], ["<b>8</b>", [3, 4]], ["<b>9</b>", [3, 5]], ["*", [3, 6]],
                ["ln", [2, 2]], ["<b>4</b>", [2, 3]], ["<b>5</b>", [2, 4]], ["<b>6</b>", [2, 5]], ["-", [2, 6]],
                ["sto→", [1, 2]], ["<b>1</b>", [1, 3]], ["<b>2</b>", [1, 4]], ["<b>3</b>", [1, 5]], ["+", [1, 6]],
                ["on", [0, 2]], ["<b>0</b>", [0, 3]], [".", [0, 4]], ["(-)", [0, 5]], ["enter", [0, 6]]
            ];
            for (let i = 0; i < keypad.length; i++) {
                const btn = keypad[i];
                if (i > 0) {
                    document.write((i % 5 === 0) ? '<br>' : '&nbsp;&nbsp;');
                }
                const specialClass = i < 5 ? 'topRowButton' : '';
                document.write(`<button id="cemu_btn_${i}" class="btn btn-default btn-sm ${specialClass}" onmousedown="pressKey(${btn[1][1]}, ${btn[1][0]}, 1);" onmouseup="setTimeout(function() \{ pressKey(${btn[1][1]}, ${btn[1][0]}, 0); }, 50);">${btn[0]}</button>`);
            }
            // Move arrows where they should be (left, up, down, right)
            document.getElementById("cemu_btn_8").style.cssText = "width: 28px;height: 35px;top: 21px;left: 16px;margin: 0;";
            document.getElementById("cemu_btn_9").style.cssText = "width: 45px;height: 19px;line-height: 14px;right: 15px;bottom: 6px;margin: 0 12px;";
            document.getElementById("cemu_btn_13").style.cssText = "width: 45px;height: 18px;line-height: 14px;left: 22px;top: 2px;margin: 0 11px;";
            document.getElementById("cemu_btn_14").style.cssText = "width: 26px;height: 35px;bottom: 25px;right: 6px;padding-left: 4px;margin: 0 2px;";
            // Move [on] and [enter] where they should be
            document.getElementById("cemu_btn_45").style.cssText = "bottom: 5px;";
            document.getElementById("cemu_btn_49").style.cssText = "bottom: 5px;";
            // Assign "numeric" class to some of the appropriate buttons
            for (i = 0; i < 3; i++) {
                document.getElementById('cemu_btn_' + (31 + i)).className += ' numeric1';
                document.getElementById('cemu_btn_' + (36 + i)).className += ' numeric2';
                document.getElementById('cemu_btn_' + (41 + i)).className += ' numeric3';
                document.getElementById('cemu_btn_' + (46 + i)).className += ' numeric4';
            }
        </script>
    </div>
    <hr id="emu_divider" style="margin:4px;display:none;"/>
    <div id="emu_control_buttons">
        <button id="emu_playpause_btn" class="btn btn-default btn-sm" style="display:none;"
                onclick="pauseEmul(!emul_is_paused)"><span id="pauseButtonIcon"
                                                           class="glyphicon glyphicon-pause"></span> <span
                id="pauseButtonLabel">Pause</span></button>
        <button id="emu_reset_btn" class="btn btn-default btn-sm" style="display:none;" onclick="resetEmul()"><span
                class="glyphicon glyphicon-asterisk"></span> Reset
        </button>
        <div id="varTransferDiv" style="display:none;">
            <input type="file" id="VarInputFile" name="file" class="inputfile inputfile-1"
                   onChange="fileLoadFromInput(event)" multiple>
            <label for="VarInputFile" class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-file"></span>
                <span class="fileInputLabel">TI file(s)</span></label>
        </div>
        <div id="ROMTransferDiv" style="display:inline-block;">
            <input type="file" id="ROMinputFile" name="file" class="inputfile inputfile-1" accept=".rom"
                   onChange="fileLoadFromInput(event)">
            <label for="ROMinputFile" class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-file"></span>
                <span class="fileInputLabel">ROM</span></label>
        </div>
    </div>

    <p style="margin-top: 4px; display: none">
        <label for="emuTransferProgress">Current transfer: </label>
        <progress id="emuTransferProgress" value="0" max="100"></progress>
    </p>

    <script src="WebCEmu_utils.js"></script>
    <script type="module">
        import WebCEmu from './WebCEmu.js';
        window.CEmu = await WebCEmu();
        initWebCEmuUtils();
    </script>

    <script type='text/javascript'>
        const debounced_resize = function () {
            const wh = window.innerHeight;
            let el = document.getElementById('emu_keypad_buttons');
            let el2 = document.getElementById('emu_control_buttons');
            if (wh < 800) {
                if (typeof window.InstallTrigger !== 'undefined') { // isFirefox
                    el.style.transformOrigin = 'center 0';
                    el.style.transform = 'scale(0.7)';
                    el2.style.position = 'absolute';
                    el2.style.bottom = '27px';
                    el2.style.left = '22px';
                    el2.style.transform = 'scale(.75)';
                    el2.style.transformOrigin = 'center 0';
                } else {
                    el.style.zoom = '70%';
                    el.style.backgroundSize = '70%';
                }
            } else {
                if (typeof window.InstallTrigger !== 'undefined') { // isFirefox
                    el.style.transformOrigin = 'unset';
                    el.style.transform = 'unset';
                    el2.style.position = 'unset';
                    el2.style.bottom = 'unset';
                    el2.style.left = 'unset';
                    el2.style.transform = 'unset';
                    el2.style.transformOrigin = 'unset';
                } else {
                    el.style.zoom = 'unset';
                    el.style.backgroundSize = '100%';
                }
            }
        };
        let debounced_resize_timeout;
        window.addEventListener('resize', () => {
            clearTimeout(debounced_resize_timeout);
            debounced_resize_timeout = setTimeout(debounced_resize, 200);
        });
        debounced_resize();
    </script>

</div>

<div id="cemu_notice">
    <span class="copyright">Emulation powered by CEmu (see <a href="https://github.com/CE-Programming/CEmu"
                                                              target="_blank">on GitHub</a>)</span>
</div>
</body>
</html>